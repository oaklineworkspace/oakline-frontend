Build Error

Failed to compile

Next.js (14.2.3) is outdated (learn more)
./pages/api/user/make-payment.js
Error: 
  Ã— the name `monthlyRate` is defined multiple times
     â•­â”€[/home/runner/workspace/pages/api/user/make-payment.js:82:1]
  82 â”‚     }
  83 â”‚ 
  84 â”‚     // Calculate payment breakdown
  85 â”‚     const monthlyRate = parseFloat(loan.interest_rate) / 100 / 12;
     Â·           â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€
     Â·                â•°â”€â”€ previous definition of `monthlyRate` here
  86 â”‚     const interestAmount = remainingBalance * monthlyRate;
  87 â”‚     const principalAmount = paymentAmount - interestAmount;
  88 â”‚     const newRemainingBalance = remainingBalance - paymentAmount;
  89 â”‚ 
  90 â”‚     // Create payment with pending status - admin must approve
  91 â”‚     const referenceNumber = `PAY-${Date.now()}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
  92 â”‚ 
  93 â”‚     const { data: paymentRecord, error: paymentError } = await supabaseAdmin
  94 â”‚       .from('loan_payments')
  95 â”‚       .insert([{
  96 â”‚         loan_id: loan_id,
  97 â”‚         account_id: account_id,
  98 â”‚         amount: parseFloat(amount),
  99 â”‚         principal_amount: principalAmount > 0 ? principalAmount : parseFloat(amount),
 100 â”‚         interest_amount: interestAmount > 0 ? interestAmount : 0,
 101 â”‚         late_fee: 0,
 102 â”‚         balance_after: newRemainingBalance,
 103 â”‚         payment_date: currentDateTime,
 104 â”‚         payment_type: payment_type || 'manual',
 105 â”‚         status: 'pending',
 106 â”‚         processed_by: user.id,
 107 â”‚         reference_number: referenceNumber,
 108 â”‚         deposit_method: 'account_balance',
 109 â”‚         notes: `Payment submitted by user. Awaiting admin confirmation.`
 110 â”‚       }])
 111 â”‚       .select()
 112 â”‚       .single();
 113 â”‚ 
 114 â”‚     if (paymentError) {
 115 â”‚       console.error('Error creating payment record:', paymentError);
 116 â”‚       // Rollback account balance
 117 â”‚       await supabaseAdmin
 118 â”‚         .from('accounts')
 119 â”‚         .update({ balance: account.balance })
 120 â”‚         .eq('id', account_id);
 121 â”‚       return res.status(500).json({ error: 'Failed to record payment' });
 122 â”‚     }
 123 â”‚ 
 124 â”‚     // Create transaction record with pending status (amount should be positive)
 125 â”‚     const { data: transaction, error: transactionError } = await supabaseAdmin
 126 â”‚       .from('transactions')
 127 â”‚       .insert([{
 128 â”‚         user_id: user.id,
 129 â”‚         account_id: account_id,
 130 â”‚         type: 'debit',
 131 â”‚         amount: parseFloat(amount), // Corrected: amount should be positive for debit transactions
 132 â”‚         balance_before: parseFloat(account.balance),
 133 â”‚         balance_after: newAccountBalance,
 134 â”‚         description: `Loan Payment - Pending Admin Approval`,
 135 â”‚         status: 'pending',
 136 â”‚         reference: referenceNumber,
 137 â”‚         created_at: currentDateTime
 138 â”‚       }])
 139 â”‚       .select()
 140 â”‚       .single();
 141 â”‚ 
 142 â”‚     if (transactionError) {
 143 â”‚       console.error('Error creating transaction record:', transactionError);
 144 â”‚     }
 145 â”‚ 
 146 â”‚     // Send notification to user
 147 â”‚     await supabaseAdmin
 148 â”‚       .from('notifications')
 149 â”‚       .insert([{
 150 â”‚         user_id: user.id,
 151 â”‚         type: 'loan',
 152 â”‚         title: 'Loan Payment Submitted',
 153 â”‚         message: `Your loan payment of $${parseFloat(amount).toLocaleString()} has been submitted and is being processed. Reference: ${referenceNumber}`,
 154 â”‚         read: false
 155 â”‚       }]);
 156 â”‚ 
 157 â”‚     // Get user profile for email
 158 â”‚     const { data: profile } = await supabaseAdmin
 159 â”‚       .from('profiles')
 160 â”‚       .select('first_name, last_name, email')
 161 â”‚       .eq('id', user.id)
 162 â”‚       .single();
 163 â”‚ 
 164 â”‚     const userName = profile ? `${profile.first_name} ${profile.last_name}` : 'Valued Customer';
 165 â”‚     const userEmail = profile?.email || user.email;
 166 â”‚ 
 167 â”‚     // Send confirmation email
 168 â”‚     const emailHtml = `
 169 â”‚       <!DOCTYPE html>
 170 â”‚       <html>
 171 â”‚       <head>
 172 â”‚         <meta charset="utf-8">
 173 â”‚         <meta name="viewport" content="width=device-width, initial-scale=1.0">
 174 â”‚       </head>
 175 â”‚       <body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background-color: #f8fafc;">
 176 â”‚         <div style="max-width: 600px; margin: 0 auto; background-color: #ffffff;">
 177 â”‚           <div style="background: linear-gradient(135deg, #1a365d 0%, #2c5aa0 100%); padding: 32px 24px; text-align: center;">
 178 â”‚             <div style="color: #ffffff; font-size: 32px; margin-bottom: 8px;">ğŸ¦</div>
 179 â”‚             <div style="color: #ffffff; font-size: 28px; font-weight: 700;">Oakline Bank</div>
 180 â”‚           </div>
 181 â”‚ 
 182 â”‚           <div style="padding: 40px 32px;">
 183 â”‚             <h1 style="color: #1a365d; font-size: 28px; font-weight: 700; margin: 0 0 16px 0;">
 184 â”‚               âœ… Payment Submitted Successfully
 185 â”‚             </h1>
 186 â”‚ 
 187 â”‚             <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 24px 0;">
 188 â”‚               Dear ${userName}, thank you for your loan payment. Your transaction has been submitted and is currently being processed by our Loan Department.
 189 â”‚             </p>
 190 â”‚ 
 191 â”‚             <div style="background-color: #f7fafc; border-radius: 12px; padding: 24px; margin: 24px 0;">
 192 â”‚               <h3 style="color: #1a365d; font-size: 18px; font-weight: 600; margin: 0 0 16px 0;">Payment Details</h3>
 193 â”‚               <table style="width: 100%; border-collapse: collapse;">
 194 â”‚                 <tr>
 195 â”‚                   <td style="padding: 8px 0; color: #64748b;">Reference Number:</td>
 196 â”‚                   <td style="padding: 8px 0; color: #1a365d; font-weight: 600; text-align: right; font-family: monospace;">${referenceNumber}</td>
 197 â”‚                 </tr>
 198 â”‚                 <tr>
 199 â”‚                   <td style="padding: 8px 0; color: #64748b;">Amount Paid:</td>
 200 â”‚                   <td style="padding: 8px 0; color: #1a365d; font-weight: 600; text-align: right;">$${paymentAmount.toFixed(2)}</td>
 201 â”‚                 </tr>
 202 â”‚                 <tr>
 203 â”‚                   <td style="padding: 8px 0; color: #64748b;">Payment Date:</td>
 204 â”‚                   <td style="padding: 8px 0; color: #1a365d; font-weight: 600; text-align: right;">${new Date().toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</td>
 205 â”‚                 </tr>
 206 â”‚                 <tr>
 207 â”‚                   <td style="padding: 8px 0; color: #64748b;">Status:</td>
 208 â”‚                   <td style="padding: 8px 0; color: #f59e0b; font-weight: 600; text-align: right;">Pending</td>
 209 â”‚                 </tr>
 210 â”‚                 <tr>
 211 â”‚                   <td style="padding: 8px 0; color: #64748b;">Loan Type:</td>
 212 â”‚                   <td style="padding: 8px 0; color: #1a365d; font-weight: 600; text-align: right;">${loan.loan_type?.replace(/_/g, ' ').toUpperCase()}</td>
 213 â”‚                 </tr>
 214 â”‚               </table>
 215 â”‚             </div>
 216 â”‚ 
 217 â”‚             <div style="background-color: #ecfdf5; border-left: 4px solid #10b981; padding: 16px; margin: 24px 0;">
 218 â”‚               <p style="color: #065f46; font-size: 14px; margin: 0;">
 219 â”‚                 Your payment is being processed. You will receive an email confirmation once complete.
 220 â”‚               </p>
 221 â”‚             </div>
 222 â”‚           </div>
 223 â”‚ 
 224 â”‚           <div style="background-color: #f7fafc; padding: 32px 24px; text-align: center; border-top: 1px solid #e2e8f0;">
 225 â”‚             <p style="color: #718096; font-size: 14px; margin: 0 0 16px 0;">
 226 â”‚               Questions? Contact our support team 24/7:
 227 â”‚             </p>
 228 â”‚             <p style="color: #4a5568; font-size: 14px; font-weight: 600; margin: 0 0 8px 0;">
 229 â”‚               ğŸ“§ contact-us@theoaklinebank.com | ğŸ“ (636) 635-6122
 230 â”‚             </p>
 231 â”‚             <div style="border-top: 1px solid #e2e8f0; padding-top: 20px; margin-top: 20px;">
 232 â”‚               <p style="color: #718096; font-size: 12px; margin: 0;">
 233 â”‚                 Â© ${new Date().getFullYear()} Oakline Bank. All rights reserved.
 234 â”‚               </p>
 235 â”‚             </div>
 236 â”‚           </div>
 237 â”‚         </div>
 238 â”‚       </body>
 239 â”‚       </html>
 240 â”‚     `;
 241 â”‚ 
 242 â”‚     try {
 243 â”‚       await sendEmail({
 244 â”‚         to: userEmail,
 245 â”‚         subject: 'âœ… Loan Payment Confirmation - Oakline Bank',
 246 â”‚         html: emailHtml,
 247 â”‚         emailType: 'loans',
 248 â”‚         userId: user.id
 249 â”‚       });
 250 â”‚     } catch (emailError) {
 251 â”‚       console.error('Error sending email:', emailError);
 252 â”‚       // Don't fail the payment if email fails
 253 â”‚     }
 254 â”‚ 
 255 â”‚     // Determine the loan status based on remaining balance and term
 256 â”‚     let loanStatus = loan.status;
 257 â”‚     if (newRemainingBalance <= 0) {
 258 â”‚       loanStatus = 'paid';
 259 â”‚     } else if (newRemainingBalance < parseFloat(loan.principal) && loan.status === 'approved') {
 260 â”‚       loanStatus = 'active';
 261 â”‚     }
 262 â”‚ 
 263 â”‚     // Update loan details including next_payment_date
 264 â”‚     // Calculate how many payments were made with this payment
 265 â”‚     // Use the actual principal paid vs expected principal per payment for accuracy
 266 â”‚     const monthlyPayment = parseFloat(loan.monthly_payment_amount || 0);
 267 â”‚     const monthlyRate = parseFloat(loan.interest_rate) / 100 / 12;
     Â·           â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€
     Â·                â•°â”€â”€ `monthlyRate` redefined here
 268 â”‚     const currentBalance = parseFloat(loan.remaining_balance || loan.principal);
 269 â”‚     
 270 â”‚     // Calculate expected principal per monthly payment
     â•°â”€â”€â”€â”€