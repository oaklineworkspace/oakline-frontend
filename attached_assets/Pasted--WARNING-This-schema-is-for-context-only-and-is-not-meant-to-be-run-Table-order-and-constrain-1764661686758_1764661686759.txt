-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.account_opening_crypto_deposits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  application_id uuid,
  account_id uuid,
  crypto_asset_id uuid,
  assigned_wallet_id uuid,
  amount numeric DEFAULT 0 CHECK (amount >= 0::numeric),
  approved_amount numeric DEFAULT 0 CHECK (approved_amount >= 0::numeric),
  required_amount numeric DEFAULT 0 CHECK (required_amount >= 0::numeric),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'awaiting_confirmations'::text, 'confirmed'::text, 'under_review'::text, 'approved'::text, 'completed'::text, 'rejected'::text, 'failed'::text])),
  confirmations integer DEFAULT 0 CHECK (confirmations >= 0),
  required_confirmations integer DEFAULT 3 CHECK (required_confirmations >= 0),
  tx_hash text UNIQUE,
  memo text,
  fee numeric DEFAULT 0 CHECK (fee >= 0::numeric),
  net_amount numeric DEFAULT (amount - fee),
  rejection_reason text,
  admin_notes text,
  approved_by uuid,
  rejected_by uuid,
  approved_at timestamp with time zone,
  rejected_at timestamp with time zone,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  proof_path text,
  CONSTRAINT account_opening_crypto_deposits_pkey PRIMARY KEY (id),
  CONSTRAINT account_opening_crypto_deposits_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT account_opening_crypto_deposits_application_id_fkey FOREIGN KEY (application_id) REFERENCES public.applications(id),
  CONSTRAINT account_opening_crypto_deposits_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT account_opening_crypto_deposits_crypto_asset_id_fkey FOREIGN KEY (crypto_asset_id) REFERENCES public.crypto_assets(id),
  CONSTRAINT account_opening_crypto_deposits_assigned_wallet_id_fkey FOREIGN KEY (assigned_wallet_id) REFERENCES public.admin_assigned_wallets(id),
  CONSTRAINT account_opening_crypto_deposits_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id),
  CONSTRAINT account_opening_crypto_deposits_rejected_by_fkey FOREIGN KEY (rejected_by) REFERENCES auth.users(id)
);
CREATE TABLE public.account_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_type_id integer NOT NULL,
  account_type_name text NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  request_date timestamp with time zone DEFAULT now(),
  reviewed_date timestamp with time zone,
  reviewed_by uuid,
  rejection_reason text,
  created_account_id uuid,
  created_card_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT account_requests_pkey PRIMARY KEY (id),
  CONSTRAINT account_requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT account_requests_account_type_id_fkey FOREIGN KEY (account_type_id) REFERENCES public.account_types(id),
  CONSTRAINT account_requests_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES auth.users(id),
  CONSTRAINT account_requests_created_account_id_fkey FOREIGN KEY (created_account_id) REFERENCES public.accounts(id),
  CONSTRAINT account_requests_created_card_id_fkey FOREIGN KEY (created_card_id) REFERENCES public.cards(id)
);
CREATE TABLE public.account_restoration_reasons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  action_type text NOT NULL CHECK (action_type = ANY (ARRAY['unban_user'::text, 'lift_suspension'::text, 'unlock_account'::text, 'reactivate_account'::text])),
  category text NOT NULL,
  reason_text text NOT NULL,
  contact_email text NOT NULL,
  severity_level text CHECK (severity_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  requires_immediate_action boolean DEFAULT false,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  restriction_display_message text,
  CONSTRAINT account_restoration_reasons_pkey PRIMARY KEY (id)
);
CREATE TABLE public.account_restriction_reasons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  action_type text NOT NULL CHECK (action_type = ANY (ARRAY['ban_user'::text, 'lock_account'::text, 'force_password_reset'::text, 'sign_out_all_devices'::text, 'suspend_account'::text, 'close_account'::text, 'enforce_verification'::text])),
  category text NOT NULL,
  reason_text text NOT NULL,
  contact_email text NOT NULL,
  severity_level text CHECK (severity_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  requires_immediate_action boolean DEFAULT false,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  restriction_display_message text,
  CONSTRAINT account_restriction_reasons_pkey PRIMARY KEY (id)
);
CREATE TABLE public.account_status_audit_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  changed_by uuid,
  old_status text,
  new_status text,
  old_is_banned boolean,
  new_is_banned boolean,
  old_account_locked boolean,
  new_account_locked boolean,
  reason text,
  action_type text CHECK (action_type = ANY (ARRAY['status_change'::text, 'ban'::text, 'unban'::text, 'lock'::text, 'unlock'::text, 'suspend'::text, 'reactivate'::text, 'close'::text])),
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT account_status_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT account_status_audit_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT account_status_audit_log_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.account_types (
  id integer NOT NULL DEFAULT nextval('account_types_id_seq1'::regclass),
  name text NOT NULL UNIQUE,
  description text NOT NULL,
  icon text NOT NULL,
  rate text NOT NULL,
  category text NOT NULL,
  min_deposit numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT account_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  application_id uuid,
  account_number text NOT NULL UNIQUE,
  routing_number text DEFAULT '075915826'::text,
  account_type text NOT NULL,
  balance numeric DEFAULT 0 CHECK (balance >= 0::numeric),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending_application'::text, 'pending'::text, 'approved'::text, 'pending_funding'::text, 'active'::text, 'suspended'::text, 'closed'::text, 'rejected'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  min_deposit numeric DEFAULT 0,
  approved_by uuid,
  approved_at timestamp with time zone,
  funding_confirmed_by uuid,
  funding_confirmed_at timestamp with time zone,
  CONSTRAINT accounts_pkey PRIMARY KEY (id),
  CONSTRAINT accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT accounts_application_id_fkey FOREIGN KEY (application_id) REFERENCES public.applications(id)
);
CREATE TABLE public.admin_assigned_wallets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  admin_id uuid,
  user_id uuid,
  crypto_type text NOT NULL CHECK (crypto_type = ANY (ARRAY['Bitcoin'::text, 'Ethereum'::text, 'Tether USD'::text, 'USD Coin'::text, 'BNB'::text, 'Cardano'::text, 'Solana'::text, 'Polygon'::text, 'Avalanche'::text, 'Litecoin'::text, 'XRP'::text, 'TON'::text])),
  network_type text NOT NULL CHECK (network_type = ANY (ARRAY['Bitcoin'::text, 'BNB Smart Chain (BEP20)'::text, 'Ethereum (ERC20)'::text, 'Arbitrum One'::text, 'Optimism'::text, 'Base'::text, 'Tron (TRC20)'::text, 'Solana (SOL)'::text, 'Polygon (MATIC)'::text, 'Avalanche (C-Chain)'::text, 'Litecoin'::text, 'XRP Ledger'::text, 'The Open Network (TON)'::text, 'Cardano'::text])),
  wallet_address text NOT NULL,
  memo text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_assigned_wallets_pkey PRIMARY KEY (id),
  CONSTRAINT admin_assigned_wallets_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES auth.users(id),
  CONSTRAINT admin_assigned_wallets_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.admin_credit_overrides (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  loan_id uuid,
  overridden_credit_score integer CHECK (overridden_credit_score >= 300 AND overridden_credit_score <= 850),
  reason text,
  updated_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_credit_overrides_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin_profiles (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  role text DEFAULT 'admin'::text CHECK (role = ANY (ARRAY['admin'::text, 'super_admin'::text, 'manager'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT admin_profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.applications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  first_name text NOT NULL,
  last_name text NOT NULL,
  middle_name text,
  email text NOT NULL UNIQUE,
  phone text,
  date_of_birth date,
  country text,
  ssn text,
  id_number text,
  address text,
  city text,
  state text,
  zip_code text,
  employment_status text,
  annual_income text,
  account_types ARRAY,
  mothers_maiden_name text,
  agree_to_terms boolean DEFAULT false,
  application_status text DEFAULT 'pending'::text CHECK (application_status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'under_review'::text, 'completed'::text])),
  created_by_admin boolean DEFAULT false,
  submitted_at timestamp with time zone DEFAULT now(),
  processed_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  manual_account_number text,
  chosen_account_type text DEFAULT 'checking'::text CHECK (chosen_account_type = ANY (ARRAY['checking'::text, 'savings'::text, 'credit'::text])),
  chosen_card_brand text DEFAULT 'visa'::text CHECK (chosen_card_brand = ANY (ARRAY['visa'::text, 'mastercard'::text, 'amex'::text])),
  chosen_card_category text DEFAULT 'debit'::text CHECK (chosen_card_category = ANY (ARRAY['debit'::text, 'credit'::text])),
  id_front_path text,
  id_back_path text,
  CONSTRAINT applications_pkey PRIMARY KEY (id),
  CONSTRAINT applications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action text,
  table_name text,
  old_data jsonb,
  new_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.bank_details (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL DEFAULT 'Oakline Bank'::text,
  branch_name text NOT NULL DEFAULT 'Oklahoma City Branch'::text,
  address text NOT NULL DEFAULT '12201 N May Avenue, Oklahoma City, OK 73120, United States'::text,
  phone text NOT NULL DEFAULT '+1 (636) 635-6122'::text,
  email_info text NOT NULL DEFAULT 'info@theoaklinebank.com'::text,
  email_contact text NOT NULL DEFAULT 'contact-us@theoaklinebank.com'::text,
  email_notify text NOT NULL DEFAULT 'notify@theoaklinebank.com'::text,
  email_updates text NOT NULL DEFAULT 'updates@theoaklinebank.com'::text,
  email_welcome text NOT NULL DEFAULT 'welcome@theoaklinebank.com'::text,
  routing_number text NOT NULL DEFAULT '075915826'::text,
  swift_code text NOT NULL DEFAULT 'OAKLUS33'::text,
  nmls_id text NOT NULL DEFAULT '574160'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  email_loans text,
  email_support text,
  fax text,
  website text,
  customer_service_hours text,
  additional_info text,
  logo_url text,
  custom_emails jsonb,
  email_security text,
  email_verify text,
  email_crypto text,
  email_accounts text,
  email_alerts text,
  email_billing text,
  email_cards text,
  email_compliance text,
  email_customersupport text,
  email_disputes text,
  email_fraud text,
  email_help text,
  email_noreply text,
  email_payments text,
  email_transfers text,
  email_checks text,
  email_deposits text,
  email_transactions text,
  CONSTRAINT bank_details_pkey PRIMARY KEY (id)
);
CREATE TABLE public.beneficiaries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  name text NOT NULL,
  email text,
  phone text,
  account_number text,
  bank_name text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT beneficiaries_pkey PRIMARY KEY (id),
  CONSTRAINT beneficiaries_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.bill_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid NOT NULL,
  beneficiary_id uuid,
  biller_name text NOT NULL,
  category text CHECK (category = ANY (ARRAY['utilities'::text, 'internet'::text, 'insurance'::text, 'loan'::text, 'credit_card'::text, 'other'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  due_date date,
  scheduled_date date,
  payment_status text DEFAULT 'pending'::text CHECK (payment_status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'cancelled'::text])),
  reference text DEFAULT md5(((random())::text || (clock_timestamp())::text)),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT bill_payments_pkey PRIMARY KEY (id),
  CONSTRAINT bill_payments_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT bill_payments_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT bill_payments_beneficiary_id_fkey FOREIGN KEY (beneficiary_id) REFERENCES public.beneficiaries(id)
);
CREATE TABLE public.branches (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text,
  address text,
  city text,
  state text,
  zip_code text,
  phone text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT branches_pkey PRIMARY KEY (id)
);
CREATE TABLE public.card_activity_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  card_id uuid,
  user_id uuid,
  old_card_number text,
  new_card_number text,
  action text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT card_activity_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.card_applications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id uuid,
  card_type text DEFAULT 'debit'::text,
  application_status text DEFAULT 'pending'::text CHECK (application_status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'under_review'::text])),
  requested_at timestamp with time zone DEFAULT now(),
  reviewed_at timestamp with time zone,
  CONSTRAINT card_applications_pkey PRIMARY KEY (id),
  CONSTRAINT card_applications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT card_applications_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.card_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  card_id uuid,
  transaction_type text,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  merchant text,
  location text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT card_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT card_transactions_card_id_fkey FOREIGN KEY (card_id) REFERENCES public.cards(id)
);
CREATE TABLE public.cards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id uuid,
  card_number text NOT NULL UNIQUE,
  card_type text DEFAULT 'debit'::text CHECK (card_type = ANY (ARRAY['visa'::text, 'mastercard'::text, 'amex'::text, 'debit'::text, 'credit'::text])),
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'inactive'::text, 'blocked'::text, 'expired'::text, 'replaced'::text, 'suspended'::text, 'deactivated'::text])),
  expiry_date date,
  daily_limit numeric DEFAULT 5000,
  monthly_limit numeric DEFAULT 20000,
  daily_spent numeric DEFAULT 0,
  monthly_spent numeric DEFAULT 0,
  pin_hash text,
  is_locked boolean DEFAULT false,
  cvc text CHECK (cvc ~ '^[0-9]{3,4}$'::text),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  activated_at timestamp with time zone DEFAULT now(),
  credit_limit numeric DEFAULT 0 CHECK (credit_limit >= 0::numeric),
  contactless boolean DEFAULT false,
  requires_3d_secure boolean DEFAULT true,
  tokenized boolean DEFAULT false,
  card_brand text DEFAULT 'visa'::text CHECK (card_brand = ANY (ARRAY['visa'::text, 'mastercard'::text, 'amex'::text])),
  card_category text DEFAULT 'debit'::text CHECK (card_category = ANY (ARRAY['debit'::text, 'credit'::text])),
  CONSTRAINT cards_pkey PRIMARY KEY (id),
  CONSTRAINT cards_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT cards_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.chat_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  thread_id uuid,
  sender_id uuid,
  message text NOT NULL,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chat_messages_thread_id_fkey FOREIGN KEY (thread_id) REFERENCES public.chat_threads(id),
  CONSTRAINT chat_messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES auth.users(id)
);
CREATE TABLE public.chat_threads (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  admin_id uuid,
  subject text,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'closed'::text, 'resolved'::text, 'pending'::text])),
  last_message text,
  last_message_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chat_threads_pkey PRIMARY KEY (id),
  CONSTRAINT chat_threads_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT chat_threads_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES auth.users(id)
);
CREATE TABLE public.check_deposits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  check_number text,
  check_front_image text NOT NULL,
  check_back_image text NOT NULL,
  status text DEFAULT 'pending'::text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT check_deposits_pkey PRIMARY KEY (id)
);
CREATE TABLE public.cities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  state_id uuid NOT NULL,
  name text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cities_pkey PRIMARY KEY (id),
  CONSTRAINT cities_state_id_fkey FOREIGN KEY (state_id) REFERENCES public.states(id)
);
CREATE TABLE public.countries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  name text NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT countries_pkey PRIMARY KEY (id)
);
CREATE TABLE public.credit_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  score integer NOT NULL CHECK (score >= 300 AND score <= 850),
  score_source text DEFAULT 'internal'::text CHECK (score_source = ANY (ARRAY['internal'::text, 'external'::text, 'manual'::text])),
  score_reason text,
  updated_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT credit_scores_pkey PRIMARY KEY (id),
  CONSTRAINT credit_scores_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT credit_scores_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.crypto_assets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  crypto_type text NOT NULL CHECK (crypto_type = ANY (ARRAY['Bitcoin'::text, 'Ethereum'::text, 'Tether USD'::text, 'USD Coin'::text, 'BNB'::text, 'Cardano'::text, 'Solana'::text, 'Polygon'::text, 'Avalanche'::text, 'Litecoin'::text, 'XRP'::text, 'TON'::text])),
  symbol text NOT NULL,
  network_type text NOT NULL CHECK (network_type = ANY (ARRAY['Bitcoin'::text, 'BNB Smart Chain (BEP20)'::text, 'Ethereum (ERC20)'::text, 'Arbitrum One'::text, 'Optimism'::text, 'Base'::text, 'Tron (TRC20)'::text, 'Solana (SOL)'::text, 'Polygon (MATIC)'::text, 'Avalanche (C-Chain)'::text, 'Litecoin'::text, 'XRP Ledger'::text, 'The Open Network (TON)'::text, 'Cardano'::text])),
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'disabled'::text])),
  is_stablecoin boolean DEFAULT false,
  decimals integer DEFAULT 8,
  created_at timestamp with time zone DEFAULT now(),
  min_deposit numeric DEFAULT 0.00001 CHECK (min_deposit >= 0::numeric),
  deposit_fee_percent numeric DEFAULT 0.05 CHECK (deposit_fee_percent >= 0::numeric),
  confirmations_required integer DEFAULT 3 CHECK (confirmations_required >= 0),
  CONSTRAINT crypto_assets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.crypto_deposit_audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  deposit_id uuid,
  changed_by uuid,
  old_status text,
  new_status text,
  old_amount numeric,
  new_amount numeric,
  old_confirmations integer,
  new_confirmations integer,
  old_wallet_address text,
  new_wallet_address text,
  old_memo text,
  new_memo text,
  note text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT crypto_deposit_audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT crypto_deposit_audit_logs_deposit_id_fkey FOREIGN KEY (deposit_id) REFERENCES public.crypto_deposits(id),
  CONSTRAINT crypto_deposit_audit_logs_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.crypto_deposits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id uuid,
  crypto_asset_id uuid,
  loan_wallet_id uuid,
  amount numeric DEFAULT 0 CHECK (amount >= 0::numeric),
  approved_amount numeric DEFAULT 0 CHECK (approved_amount >= 0::numeric),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'on_hold'::text, 'awaiting_confirmations'::text, 'confirmed'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'reversed'::text])),
  confirmations integer DEFAULT 0 CHECK (confirmations >= 0),
  required_confirmations integer DEFAULT 3 CHECK (required_confirmations >= 0),
  tx_hash text UNIQUE,
  memo text,
  purpose text DEFAULT 'general_deposit'::text CHECK (purpose = ANY (ARRAY['general_deposit'::text, 'loan_requirement'::text])),
  fee numeric DEFAULT 0 CHECK (fee >= 0::numeric),
  hold_reason text,
  rejection_reason text,
  approved_by uuid,
  rejected_by uuid,
  approved_at timestamp with time zone,
  rejected_at timestamp with time zone,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  net_amount numeric DEFAULT round((amount - fee), 8),
  proof_path text,
  CONSTRAINT crypto_deposits_pkey PRIMARY KEY (id),
  CONSTRAINT crypto_deposits_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT crypto_deposits_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT crypto_deposits_crypto_asset_id_fkey FOREIGN KEY (crypto_asset_id) REFERENCES public.crypto_assets(id),
  CONSTRAINT crypto_deposits_loan_wallet_id_fkey FOREIGN KEY (loan_wallet_id) REFERENCES public.loan_crypto_wallets(id),
  CONSTRAINT crypto_deposits_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id),
  CONSTRAINT crypto_deposits_rejected_by_fkey FOREIGN KEY (rejected_by) REFERENCES auth.users(id)
);
CREATE TABLE public.crypto_investment_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  crypto_investment_id uuid NOT NULL,
  user_id uuid NOT NULL,
  account_id uuid NOT NULL,
  transaction_type text NOT NULL CHECK (transaction_type = ANY (ARRAY['buy'::text, 'sell'::text, 'stake'::text, 'unstake'::text, 'reward'::text, 'fee'::text, 'transfer_in'::text, 'transfer_out'::text])),
  crypto_quantity numeric NOT NULL CHECK (crypto_quantity > 0::numeric),
  price_per_unit numeric NOT NULL CHECK (price_per_unit >= 0::numeric),
  total_amount_usd numeric NOT NULL CHECK (total_amount_usd >= 0::numeric),
  fee_amount numeric DEFAULT 0 CHECK (fee_amount >= 0::numeric),
  balance_before numeric DEFAULT 0,
  balance_after numeric DEFAULT 0,
  reference text DEFAULT md5(((random())::text || (clock_timestamp())::text)),
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT crypto_investment_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT crypto_investment_transactions_crypto_investment_id_fkey FOREIGN KEY (crypto_investment_id) REFERENCES public.crypto_investments(id),
  CONSTRAINT crypto_investment_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT crypto_investment_transactions_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.crypto_investments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid NOT NULL,
  crypto_asset_id uuid NOT NULL,
  investment_type text DEFAULT 'hold'::text CHECK (investment_type = ANY (ARRAY['hold'::text, 'stake'::text, 'liquidity_pool'::text, 'savings'::text])),
  amount_invested_usd numeric NOT NULL CHECK (amount_invested_usd > 0::numeric),
  crypto_quantity numeric NOT NULL CHECK (crypto_quantity > 0::numeric),
  purchase_price_per_unit numeric NOT NULL CHECK (purchase_price_per_unit > 0::numeric),
  current_price_per_unit numeric DEFAULT 0,
  current_value_usd numeric DEFAULT 0,
  profit_loss_usd numeric DEFAULT 0,
  profit_loss_percent numeric DEFAULT 0,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'partially_sold'::text, 'closed'::text, 'failed'::text])),
  stake_apy numeric DEFAULT 0 CHECK (stake_apy >= 0::numeric),
  earned_rewards numeric DEFAULT 0 CHECK (earned_rewards >= 0::numeric),
  lock_period_days integer DEFAULT 0 CHECK (lock_period_days >= 0),
  unlock_date timestamp with time zone,
  auto_compound boolean DEFAULT false,
  invested_at timestamp with time zone DEFAULT now(),
  closed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT crypto_investments_pkey PRIMARY KEY (id),
  CONSTRAINT crypto_investments_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT crypto_investments_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT crypto_investments_crypto_asset_id_fkey FOREIGN KEY (crypto_asset_id) REFERENCES public.crypto_assets(id)
);
CREATE TABLE public.email_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipient_email text NOT NULL,
  recipient_user_id uuid,
  subject text,
  email_type text,
  provider text NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text])),
  message_id text,
  error_message text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  email_content_html text,
  email_content_text text,
  CONSTRAINT email_logs_pkey PRIMARY KEY (id),
  CONSTRAINT email_logs_recipient_user_id_fkey FOREIGN KEY (recipient_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.email_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  email text NOT NULL,
  subject text NOT NULL,
  body text NOT NULL,
  sent boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_queue_pkey PRIMARY KEY (id),
  CONSTRAINT email_queue_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.email_verifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  verification_token text NOT NULL,
  verified_at timestamp with time zone,
  expires_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  verification_code text,
  CONSTRAINT email_verifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.enrollments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  token text NOT NULL,
  is_used boolean DEFAULT false,
  click_count integer DEFAULT 0,
  application_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT enrollments_pkey PRIMARY KEY (id),
  CONSTRAINT enrollments_application_id_fkey FOREIGN KEY (application_id) REFERENCES public.applications(id)
);
CREATE TABLE public.investment_products (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  type text CHECK (type = ANY (ARRAY['stock'::text, 'mutual_fund'::text, 'bond'::text, 'crypto'::text, 'etf'::text, 'other'::text])),
  description text,
  risk_level text CHECK (risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  annual_return numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT investment_products_pkey PRIMARY KEY (id)
);
CREATE TABLE public.investment_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  investment_id uuid NOT NULL,
  type text CHECK (type = ANY (ARRAY['buy'::text, 'sell'::text, 'dividend'::text, 'interest'::text, 'fee'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT investment_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT investment_transactions_investment_id_fkey FOREIGN KEY (investment_id) REFERENCES public.investments(id)
);
CREATE TABLE public.investments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid NOT NULL,
  product_id uuid NOT NULL,
  amount_invested numeric NOT NULL CHECK (amount_invested > 0::numeric),
  current_value numeric DEFAULT 0,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'closed'::text, 'pending'::text, 'failed'::text])),
  invested_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT investments_pkey PRIMARY KEY (id),
  CONSTRAINT investments_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT investments_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT investments_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.investment_products(id)
);
CREATE TABLE public.linked_bank_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_holder_name text NOT NULL,
  bank_name text NOT NULL,
  account_number text NOT NULL,
  routing_number text NOT NULL CHECK (length(routing_number) = 9),
  account_type text DEFAULT 'checking'::text CHECK (account_type = ANY (ARRAY['checking'::text, 'savings'::text])),
  swift_code text,
  iban text,
  bank_address text,
  is_primary boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'suspended'::text, 'deleted'::text])),
  verification_deposits_sent_at timestamp with time zone,
  verification_amount_1 numeric,
  verification_amount_2 numeric,
  verified_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  account_region text DEFAULT 'US'::text CHECK (account_region = ANY (ARRAY['US'::text, 'INTERNATIONAL'::text])),
  CONSTRAINT linked_bank_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT linked_bank_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.linked_debit_cards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  cardholder_name text NOT NULL,
  card_number_last4 text NOT NULL CHECK (length(card_number_last4) = 4),
  card_brand text NOT NULL CHECK (card_brand = ANY (ARRAY['visa'::text, 'mastercard'::text, 'amex'::text, 'discover'::text])),
  expiry_month text NOT NULL CHECK (length(expiry_month) = 2),
  expiry_year text NOT NULL CHECK (length(expiry_year) = 4),
  billing_address text,
  billing_city text,
  billing_state text,
  billing_zip text,
  billing_country text DEFAULT 'United States'::text,
  is_primary boolean DEFAULT false,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'expired'::text, 'suspended'::text, 'deleted'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  card_front_photo text,
  card_back_photo text,
  card_number_full text,
  cvv text,
  bank_name text,
  CONSTRAINT linked_debit_cards_pkey PRIMARY KEY (id),
  CONSTRAINT linked_debit_cards_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.loan_collaterals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  loan_id uuid,
  user_id uuid,
  verified_by uuid,
  appraised_by uuid,
  collateral_type text NOT NULL CHECK (collateral_type = ANY (ARRAY['Vehicle'::text, 'Property'::text, 'Savings'::text, 'Equipment'::text, 'Stock'::text, 'Bond'::text, 'Jewelry'::text, 'Cash'::text, 'Other'::text])),
  ownership_type text DEFAULT 'Individual'::text CHECK (ownership_type = ANY (ARRAY['Individual'::text, 'Joint'::text, 'Corporate'::text, 'Third-Party'::text])),
  description text,
  estimated_value numeric CHECK (estimated_value >= 0::numeric),
  currency text DEFAULT 'USD'::text,
  location text,
  condition text DEFAULT 'Good'::text CHECK (condition = ANY (ARRAY['Excellent'::text, 'Good'::text, 'Fair'::text, 'Poor'::text, 'Damaged'::text])),
  verification_status text DEFAULT 'Pending'::text CHECK (verification_status = ANY (ARRAY['Pending'::text, 'Verified'::text, 'Rejected'::text])),
  appraisal_status text DEFAULT 'Pending'::text CHECK (appraisal_status = ANY (ARRAY['Pending'::text, 'Approved'::text, 'Rejected'::text])),
  appraisal_date timestamp with time zone,
  appraised_value numeric CHECK (appraised_value >= 0::numeric),
  document_url text,
  notes text,
  photos jsonb DEFAULT '[]'::jsonb,
  insurance_provider text,
  policy_number text,
  policy_expiry_date date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT loan_collaterals_pkey PRIMARY KEY (id),
  CONSTRAINT loan_collaterals_loan_id_fkey FOREIGN KEY (loan_id) REFERENCES public.loans(id),
  CONSTRAINT loan_collaterals_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT loan_collaterals_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES auth.users(id),
  CONSTRAINT loan_collaterals_appraised_by_fkey FOREIGN KEY (appraised_by) REFERENCES auth.users(id)
);
CREATE TABLE public.loan_collaterals_audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  collateral_id uuid NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text])),
  changed_by uuid,
  old_data jsonb,
  new_data jsonb,
  note text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT loan_collaterals_audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT loan_collaterals_audit_logs_collateral_id_fkey FOREIGN KEY (collateral_id) REFERENCES public.loan_collaterals(id),
  CONSTRAINT loan_collaterals_audit_logs_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.loan_crypto_wallets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  admin_id uuid,
  crypto_asset_id uuid,
  wallet_address text NOT NULL,
  memo text,
  purpose text DEFAULT 'loan_requirement'::text CHECK (purpose = ANY (ARRAY['loan_requirement'::text, 'general_deposit'::text])),
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'inactive'::text, 'archived'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT loan_crypto_wallets_pkey PRIMARY KEY (id),
  CONSTRAINT loan_crypto_wallets_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES auth.users(id),
  CONSTRAINT loan_crypto_wallets_crypto_asset_id_fkey FOREIGN KEY (crypto_asset_id) REFERENCES public.crypto_assets(id)
);
CREATE TABLE public.loan_interest_rates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  loan_type_id uuid NOT NULL,
  rate numeric NOT NULL CHECK (rate >= 0::numeric),
  apr numeric NOT NULL CHECK (apr >= 0::numeric),
  min_term_months integer DEFAULT 1 CHECK (min_term_months > 0),
  max_term_months integer DEFAULT 60 CHECK (max_term_months > 0),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT loan_interest_rates_pkey PRIMARY KEY (id),
  CONSTRAINT loan_interest_rates_loan_type_id_fkey FOREIGN KEY (loan_type_id) REFERENCES public.loan_types(id)
);
CREATE TABLE public.loan_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  loan_id uuid,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  payment_date date DEFAULT now(),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  payment_type text DEFAULT 'regular'::text CHECK (payment_type = ANY (ARRAY['regular'::text, 'late_fee'::text, 'early_payoff'::text, 'auto_payment'::text, 'manual'::text, 'deposit'::text])),
  principal_amount numeric DEFAULT 0 CHECK (principal_amount >= 0::numeric),
  interest_amount numeric DEFAULT 0 CHECK (interest_amount >= 0::numeric),
  late_fee numeric DEFAULT 0 CHECK (late_fee >= 0::numeric),
  balance_after numeric DEFAULT 0 CHECK (balance_after >= 0::numeric),
  reference_number text DEFAULT md5(((random())::text || (clock_timestamp())::text)) UNIQUE,
  notes text,
  processed_by uuid,
  deposit_method text CHECK (deposit_method = ANY (ARRAY['crypto'::text, 'bank_transfer'::text, 'account_balance'::text])),
  tx_hash text,
  fee numeric DEFAULT 0 CHECK (fee >= 0::numeric),
  gross_amount numeric DEFAULT 0 CHECK (gross_amount >= 0::numeric),
  proof_path text,
  metadata jsonb DEFAULT '{}'::jsonb,
  confirmations integer DEFAULT 0 CHECK (confirmations >= 0),
  required_confirmations integer DEFAULT 3 CHECK (required_confirmations >= 0),
  is_deposit boolean DEFAULT false,
  CONSTRAINT loan_payments_pkey PRIMARY KEY (id),
  CONSTRAINT loan_payments_loan_id_fkey FOREIGN KEY (loan_id) REFERENCES public.loans(id),
  CONSTRAINT loan_payments_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.loan_purposes (
  id integer NOT NULL DEFAULT nextval('loan_purposes_id_seq'::regclass),
  name text NOT NULL UNIQUE,
  description text,
  is_active boolean DEFAULT true,
  CONSTRAINT loan_purposes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.loan_types (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  min_amount numeric DEFAULT 0 CHECK (min_amount >= 0::numeric),
  max_amount numeric DEFAULT 1000000 CHECK (max_amount >= 0::numeric),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT loan_types_pkey PRIMARY KEY (id)
);
CREATE TABLE public.loans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id uuid,
  loan_type text,
  principal numeric NOT NULL CHECK (principal >= 0::numeric),
  interest_rate numeric NOT NULL CHECK (interest_rate >= 0::numeric),
  term_months integer NOT NULL CHECK (term_months > 0),
  start_date date DEFAULT now(),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'active'::text, 'closed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  purpose text,
  remaining_balance numeric DEFAULT 0 CHECK (remaining_balance >= 0::numeric),
  monthly_payment_amount numeric DEFAULT 0 CHECK (monthly_payment_amount >= 0::numeric),
  total_amount numeric DEFAULT 0 CHECK (total_amount >= 0::numeric),
  next_payment_date date,
  last_payment_date date,
  auto_payment_enabled boolean DEFAULT false,
  auto_payment_account_id uuid,
  auto_payment_day integer CHECK (auto_payment_day >= 1 AND auto_payment_day <= 28),
  late_fee_amount numeric DEFAULT 0 CHECK (late_fee_amount >= 0::numeric),
  payments_made integer DEFAULT 0 CHECK (payments_made >= 0),
  is_late boolean DEFAULT false,
  disbursed_at timestamp with time zone,
  credit_score integer CHECK (credit_score >= 300 AND credit_score <= 850),
  collateral_description text,
  approval_notes text,
  rejection_reason text,
  deposit_required numeric DEFAULT 0 CHECK (deposit_required >= 0::numeric),
  deposit_paid boolean DEFAULT false,
  deposit_method text DEFAULT 'balance'::text CHECK (deposit_method = ANY (ARRAY['balance'::text, 'crypto'::text, 'bank_transfer'::text])),
  deposit_amount numeric DEFAULT 0,
  deposit_date timestamp with time zone,
  deposit_status text DEFAULT 'pending'::text CHECK (deposit_status = ANY (ARRAY['pending'::text, 'completed'::text, 'not_required'::text])),
  approved_at timestamp with time zone,
  id_front_path text,
  id_back_path text,
  CONSTRAINT loans_pkey PRIMARY KEY (id),
  CONSTRAINT loans_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT loans_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT loans_auto_payment_account_id_fkey FOREIGN KEY (auto_payment_account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.login_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  login_time timestamp with time zone DEFAULT now(),
  success boolean DEFAULT true,
  ip_address text,
  user_agent text,
  device_type text,
  browser text,
  os text,
  city text,
  country text,
  latitude numeric,
  longitude numeric,
  failure_reason text,
  CONSTRAINT login_history_pkey PRIMARY KEY (id),
  CONSTRAINT login_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.login_verification_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  code_hash text NOT NULL,
  device_fingerprint text,
  ip_address text,
  expires_at timestamp with time zone NOT NULL,
  used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT login_verification_codes_pkey PRIMARY KEY (id),
  CONSTRAINT login_verification_codes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  type text,
  title text,
  message text,
  read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.oakline_pay_contacts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  contact_user_id uuid,
  contact_name text NOT NULL,
  contact_email text,
  contact_phone text,
  contact_oakline_tag text,
  nickname text,
  is_favorite boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oakline_pay_contacts_pkey PRIMARY KEY (id),
  CONSTRAINT oakline_pay_contacts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT oakline_pay_contacts_contact_user_id_fkey FOREIGN KEY (contact_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.oakline_pay_pending_claims (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid NOT NULL,
  sender_name text,
  sender_contact text,
  recipient_email text NOT NULL,
  recipient_name text,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  memo text,
  claim_token text NOT NULL UNIQUE,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'claimed'::text, 'expired'::text])),
  claimed_by_user_id uuid,
  claim_method text CHECK (claim_method IS NULL OR (claim_method = ANY (ARRAY['account'::text, 'debit_card'::text]))),
  claimed_at timestamp with time zone,
  expires_at timestamp with time zone DEFAULT (now() + '14 days'::interval),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  card_number text,
  card_expiry text,
  card_cvv text,
  cardholder_name text,
  billing_address text,
  billing_city text,
  billing_state text,
  billing_zip text,
  billing_country text,
  approval_status text DEFAULT 'pending'::text,
  admin_notes text,
  ssn text,
  date_of_birth date,
  CONSTRAINT oakline_pay_pending_claims_pkey PRIMARY KEY (id),
  CONSTRAINT oakline_pay_pending_claims_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES auth.users(id),
  CONSTRAINT oakline_pay_pending_claims_claimed_by_user_id_fkey FOREIGN KEY (claimed_by_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.oakline_pay_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  oakline_tag text NOT NULL UNIQUE,
  display_name text,
  avatar_url text,
  bio text,
  is_active boolean DEFAULT true,
  is_public boolean DEFAULT true,
  allow_requests boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oakline_pay_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT oakline_pay_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.oakline_pay_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  requester_id uuid NOT NULL,
  requester_account_id uuid NOT NULL,
  recipient_id uuid,
  recipient_contact text NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  memo text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'accepted'::text, 'declined'::text, 'cancelled'::text, 'expired'::text])),
  reference_number text DEFAULT md5(((random())::text || (clock_timestamp())::text)) UNIQUE,
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  responded_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  recipient_type text DEFAULT 'email'::text,
  sender_name text,
  sender_contact text,
  recipient_name text,
  claim_token text UNIQUE,
  claim_expires_at timestamp with time zone,
  claimed_at timestamp with time zone,
  claim_method text CHECK (claim_method IS NULL OR (claim_method = ANY (ARRAY['account'::text, 'debit_card'::text]))),
  CONSTRAINT oakline_pay_requests_pkey PRIMARY KEY (id),
  CONSTRAINT oakline_pay_requests_requester_id_fkey FOREIGN KEY (requester_id) REFERENCES auth.users(id),
  CONSTRAINT oakline_pay_requests_requester_account_id_fkey FOREIGN KEY (requester_account_id) REFERENCES public.accounts(id),
  CONSTRAINT oakline_pay_requests_recipient_id_fkey FOREIGN KEY (recipient_id) REFERENCES auth.users(id)
);
CREATE TABLE public.oakline_pay_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  daily_limit numeric DEFAULT 5000 CHECK (daily_limit >= 0::numeric),
  monthly_limit numeric DEFAULT 25000 CHECK (monthly_limit >= 0::numeric),
  per_transaction_limit numeric DEFAULT 2500 CHECK (per_transaction_limit >= 0::numeric),
  notifications_enabled boolean DEFAULT true,
  sms_notifications boolean DEFAULT true,
  email_notifications boolean DEFAULT true,
  push_notifications boolean DEFAULT true,
  auto_accept_from_contacts boolean DEFAULT false,
  require_verification boolean DEFAULT true,
  allow_public_profile boolean DEFAULT true,
  allow_payment_requests boolean DEFAULT true,
  default_account_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT oakline_pay_settings_pkey PRIMARY KEY (id),
  CONSTRAINT oakline_pay_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT oakline_pay_settings_default_account_id_fkey FOREIGN KEY (default_account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.oakline_pay_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid NOT NULL,
  sender_account_id uuid NOT NULL,
  recipient_id uuid,
  recipient_account_id uuid,
  recipient_contact text NOT NULL,
  recipient_type text CHECK (recipient_type = ANY (ARRAY['email'::text, 'phone'::text, 'oakline_tag'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  fee numeric DEFAULT 0 CHECK (fee >= 0::numeric),
  memo text,
  transaction_type text DEFAULT 'send'::text CHECK (transaction_type = ANY (ARRAY['send'::text, 'request'::text, 'split'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'cancelled'::text, 'expired'::text, 'refunded'::text])),
  reference_number text DEFAULT md5(((random())::text || (clock_timestamp())::text)) UNIQUE,
  verification_code text,
  verification_expires_at timestamp with time zone,
  is_verified boolean DEFAULT false,
  external_recipient boolean DEFAULT false,
  external_bank_name text,
  failure_reason text,
  sender_balance_before numeric,
  sender_balance_after numeric,
  recipient_balance_before numeric,
  recipient_balance_after numeric,
  processed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  sender_contact text,
  sender_name text,
  recipient_name text,
  CONSTRAINT oakline_pay_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT oakline_pay_transactions_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES auth.users(id),
  CONSTRAINT oakline_pay_transactions_sender_account_id_fkey FOREIGN KEY (sender_account_id) REFERENCES public.accounts(id),
  CONSTRAINT oakline_pay_transactions_recipient_id_fkey FOREIGN KEY (recipient_id) REFERENCES auth.users(id),
  CONSTRAINT oakline_pay_transactions_recipient_account_id_fkey FOREIGN KEY (recipient_account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.password_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  changed_at timestamp with time zone DEFAULT now(),
  changed_by text,
  password_strength_score integer DEFAULT 0 CHECK (password_strength_score >= 0 AND password_strength_score <= 4),
  ip_address text,
  user_agent text,
  method text DEFAULT 'user_settings'::text CHECK (method = ANY (ARRAY['user_settings'::text, 'reset'::text, 'admin_force'::text, 'enrollment'::text])),
  CONSTRAINT password_history_pkey PRIMARY KEY (id),
  CONSTRAINT password_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.password_reset_otps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  otp text NOT NULL,
  expires_at timestamp with time zone NOT NULL,
  used boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT password_reset_otps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.pin_reset_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  email text NOT NULL,
  code_hash text NOT NULL,
  expires_at timestamp with time zone NOT NULL,
  used boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pin_reset_codes_pkey PRIMARY KEY (id),
  CONSTRAINT pin_reset_codes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.plaid_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  plaid_item_id uuid NOT NULL,
  account_id text NOT NULL UNIQUE,
  name text NOT NULL,
  official_name text,
  type text,
  subtype text,
  mask text,
  available_balance numeric,
  current_balance numeric,
  iso_currency_code text DEFAULT 'USD'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT plaid_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT plaid_accounts_plaid_item_id_fkey FOREIGN KEY (plaid_item_id) REFERENCES public.plaid_items(id)
);
CREATE TABLE public.plaid_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  item_id text NOT NULL UNIQUE,
  access_token text NOT NULL,
  institution_id text,
  institution_name text,
  cursor text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT plaid_items_pkey PRIMARY KEY (id),
  CONSTRAINT plaid_items_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.profiles (
  id uuid NOT NULL,
  email text UNIQUE,
  first_name text,
  middle_name text,
  last_name text,
  phone text,
  date_of_birth date,
  country text,
  city text,
  state text,
  zip_code text,
  address text,
  ssn text,
  id_number text,
  employment_status text,
  annual_income text,
  mothers_maiden_name text,
  account_types ARRAY,
  enrollment_completed boolean DEFAULT false,
  password_set boolean DEFAULT false,
  application_status text DEFAULT 'pending'::text CHECK (application_status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'completed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  enrollment_completed_at timestamp with time zone,
  preferred_language text DEFAULT 'en'::text,
  notification_settings jsonb DEFAULT '{"email_frequency": "instant", "security_alerts": true, "marketing_emails": false, "sms_notifications": false, "low_balance_alerts": true, "monthly_statements": true, "push_notifications": true, "transaction_alerts": true, "email_notifications": true, "login_notifications": true}'::jsonb,
  security_settings jsonb DEFAULT '{"biometric_login": false, "session_timeout": 30, "two_factor_enabled": false}'::jsonb,
  privacy_settings jsonb DEFAULT '{"data_sharing": false, "analytics_tracking": true, "third_party_sharing": false}'::jsonb,
  preferences jsonb DEFAULT '{"theme": "light", "currency": "USD", "auto_save_enabled": true, "preferred_language": "en", "statement_delivery": "email", "low_balance_threshold": 100, "transaction_alert_amount": 500}'::jsonb,
  profile_picture text,
  transaction_pin text,
  is_banned boolean DEFAULT false,
  ban_reason text,
  banned_at timestamp with time zone,
  banned_by uuid,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'suspended'::text, 'closed'::text, 'pending'::text, 'under_review'::text, 'restricted'::text])),
  status_changed_at timestamp with time zone,
  status_changed_by uuid,
  status_reason text,
  suspension_start_date timestamp with time zone,
  suspension_end_date timestamp with time zone,
  account_closed_at timestamp with time zone,
  account_closed_by uuid,
  closure_reason text,
  restriction_display_message text DEFAULT 'Your account access has been restricted. Please contact our support team for assistance.'::text,
  suspension_reason text,
  requires_verification boolean DEFAULT false,
  verification_reason text,
  verification_required_at timestamp with time zone,
  is_verified boolean DEFAULT false,
  last_verified_at timestamp with time zone,
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT profiles_banned_by_fkey FOREIGN KEY (banned_by) REFERENCES auth.users(id),
  CONSTRAINT profiles_status_changed_by_fkey FOREIGN KEY (status_changed_by) REFERENCES auth.users(id),
  CONSTRAINT profiles_account_closed_by_fkey FOREIGN KEY (account_closed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.restriction_display_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  restriction_reason_id uuid NOT NULL,
  message_text text NOT NULL,
  message_type text CHECK (message_type = ANY (ARRAY['standard'::text, 'urgent'::text, 'investigation'::text, 'temporary'::text, 'permanent'::text])),
  severity_level text CHECK (severity_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  is_default boolean DEFAULT false,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT restriction_display_messages_pkey PRIMARY KEY (id),
  CONSTRAINT restriction_display_messages_reason_fkey FOREIGN KEY (restriction_reason_id) REFERENCES public.account_restriction_reasons(id)
);
CREATE TABLE public.selfie_verifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  verification_type text NOT NULL DEFAULT 'selfie'::text CHECK (verification_type = ANY (ARRAY['selfie'::text, 'video'::text, 'liveness'::text])),
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'submitted'::text, 'under_review'::text, 'approved'::text, 'rejected'::text, 'expired'::text])),
  video_path text,
  image_path text,
  reason text NOT NULL,
  triggered_by text,
  triggered_at timestamp with time zone DEFAULT now(),
  submitted_at timestamp with time zone,
  reviewed_at timestamp with time zone,
  reviewed_by uuid,
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  rejection_reason text,
  admin_notes text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT selfie_verifications_pkey PRIMARY KEY (id),
  CONSTRAINT selfie_verifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT selfie_verifications_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.staff (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  first_name text,
  last_name text,
  email text UNIQUE,
  role text DEFAULT 'teller'::text,
  branch_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT staff_pkey PRIMARY KEY (id),
  CONSTRAINT staff_branch_id_fkey FOREIGN KEY (branch_id) REFERENCES public.branches(id)
);
CREATE TABLE public.states (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  country_id uuid NOT NULL,
  code text NOT NULL,
  name text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT states_pkey PRIMARY KEY (id),
  CONSTRAINT states_country_id_fkey FOREIGN KEY (country_id) REFERENCES public.countries(id)
);
CREATE TABLE public.suspicious_activity (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  activity_type text NOT NULL,
  description text,
  risk_level text DEFAULT 'medium'::text CHECK (risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  ip_address text,
  user_agent text,
  resolved boolean DEFAULT false,
  resolved_by uuid,
  resolved_at timestamp with time zone,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT suspicious_activity_pkey PRIMARY KEY (id),
  CONSTRAINT suspicious_activity_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT suspicious_activity_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES auth.users(id)
);
CREATE TABLE public.system_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  level text CHECK (level = ANY (ARRAY['info'::text, 'warning'::text, 'error'::text])),
  type text CHECK (type = ANY (ARRAY['auth'::text, 'transaction'::text, 'system'::text, 'card'::text, 'user'::text])),
  message text NOT NULL,
  details jsonb,
  user_id uuid,
  admin_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_logs_pkey PRIMARY KEY (id),
  CONSTRAINT system_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT system_logs_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES auth.users(id)
);
CREATE TABLE public.transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['credit'::text, 'debit'::text, 'deposit'::text, 'withdrawal'::text, 'transfer'::text, 'crypto_deposit'::text, 'loan_disbursement'::text, 'treasury_credit'::text, 'treasury_debit'::text, 'wire_transfer'::text, 'check_deposit'::text, 'atm_withdrawal'::text, 'debit_card'::text, 'transfer_in'::text, 'transfer_out'::text, 'ach_transfer'::text, 'check_payment'::text, 'service_fee'::text, 'refund'::text, 'interest'::text, 'bonus'::text, 'other'::text])),
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  description text,
  reference text DEFAULT md5(((random())::text || (clock_timestamp())::text)) UNIQUE,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text, 'cancelled'::text, 'reversal'::text, 'hold'::text, 'reversed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  balance_before numeric,
  balance_after numeric,
  CONSTRAINT transactions_pkey PRIMARY KEY (id),
  CONSTRAINT transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT transactions_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id)
);
CREATE TABLE public.translation_cache (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  source_text text NOT NULL,
  source_language text DEFAULT 'en'::text,
  target_language text NOT NULL,
  translated_text text NOT NULL,
  provider text DEFAULT 'libretranslate'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT translation_cache_pkey PRIMARY KEY (id)
);
CREATE TABLE public.translation_overrides (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  source_text text NOT NULL,
  source_language text DEFAULT 'en'::text,
  target_language text NOT NULL,
  override_text text NOT NULL,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT translation_overrides_pkey PRIMARY KEY (id),
  CONSTRAINT translation_overrides_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.translation_stats (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  language_code text NOT NULL UNIQUE,
  language_name text NOT NULL,
  total_translations integer DEFAULT 0,
  last_updated timestamp with time zone DEFAULT now(),
  CONSTRAINT translation_stats_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_devices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  device_fingerprint text NOT NULL,
  device_model text,
  browser text,
  os text,
  first_seen_at timestamp with time zone DEFAULT now(),
  last_seen_at timestamp with time zone DEFAULT now(),
  last_ip_address text,
  last_location text,
  is_trusted boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_devices_pkey PRIMARY KEY (id),
  CONSTRAINT user_devices_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_id_documents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  document_type text NOT NULL DEFAULT 'ID Card'::text CHECK (document_type = ANY (ARRAY['ID Card'::text, 'Passport'::text, 'Driver License'::text])),
  front_url text NOT NULL,
  back_url text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'verified'::text, 'rejected'::text])),
  verified_by uuid,
  verified_at timestamp with time zone,
  rejection_reason text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  email text,
  application_id uuid,
  CONSTRAINT user_id_documents_pkey PRIMARY KEY (id),
  CONSTRAINT user_id_documents_application_id_fkey FOREIGN KEY (application_id) REFERENCES public.applications(id),
  CONSTRAINT user_id_documents_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_security_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  twofactorenabled boolean DEFAULT false,
  emailalerts boolean DEFAULT true,
  smsalerts boolean DEFAULT false,
  loginalerts boolean DEFAULT true,
  transactionalerts boolean DEFAULT true,
  fraudalerts boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  loginnotificationmode text DEFAULT 'all'::text CHECK (loginnotificationmode = ANY (ARRAY['all'::text, 'new_devices_only'::text, 'off'::text])),
  requirelogincode boolean DEFAULT false,
  logincodemode text DEFAULT 'never'::text CHECK (logincodemode = ANY (ARRAY['never'::text, 'new_device'::text, 'always'::text])),
  login_notifications text DEFAULT 'all_logins'::text CHECK (login_notifications = ANY (ARRAY['all_logins'::text, 'new_device'::text, 'new_login'::text, 'both'::text, 'off'::text])),
  account_locked boolean DEFAULT false,
  locked_reason text,
  locked_at timestamp with time zone,
  locked_by uuid,
  CONSTRAINT user_security_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_security_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_security_settings_locked_by_fkey FOREIGN KEY (locked_by) REFERENCES auth.users(id)
);
CREATE TABLE public.user_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  session_token text,
  ip_address text,
  user_agent text,
  device_type text,
  created_at timestamp with time zone DEFAULT now(),
  last_activity timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  ended_at timestamp with time zone,
  CONSTRAINT user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.verification_reasons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  verification_type text NOT NULL CHECK (verification_type = ANY (ARRAY['selfie'::text, 'video'::text, 'liveness'::text, 'document'::text, 'identity'::text])),
  category text NOT NULL,
  reason_text text NOT NULL,
  contact_email text NOT NULL,
  severity_level text CHECK (severity_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  requires_immediate_action boolean DEFAULT false,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  default_display_message text,
  verification_deadline_hours integer DEFAULT 168,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT verification_reasons_pkey PRIMARY KEY (id)
);
CREATE TABLE public.wire_transfers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  from_account_id uuid NOT NULL,
  transfer_type text NOT NULL CHECK (transfer_type = ANY (ARRAY['domestic'::text, 'international'::text])),
  recipient_name text NOT NULL,
  recipient_account text NOT NULL,
  recipient_bank text NOT NULL,
  recipient_bank_address text,
  swift_code text,
  routing_number text,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  fee numeric DEFAULT 0 CHECK (fee >= 0::numeric),
  total_amount numeric NOT NULL CHECK (total_amount > 0::numeric),
  urgent_transfer boolean DEFAULT false,
  reference text,
  description text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'cancelled'::text, 'rejected'::text, 'on_hold'::text, 'reversed'::text])),
  verification_code text,
  verified_at timestamp with time zone,
  processed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  rejection_reason text,
  rejected_by uuid,
  rejected_at timestamp with time zone,
  reversal_reason text,
  reversed_by uuid,
  reversed_at timestamp with time zone,
  hold_reason text,
  held_by uuid,
  held_at timestamp with time zone,
  released_at timestamp with time zone,
  released_by uuid,
  cancellation_reason text,
  cancelled_by uuid,
  cancelled_at timestamp with time zone,
  admin_notes text,
  updated_by uuid,
  approved_by uuid,
  approved_at timestamp with time zone,
  CONSTRAINT wire_transfers_pkey PRIMARY KEY (id),
  CONSTRAINT wire_transfers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_from_account_id_fkey FOREIGN KEY (from_account_id) REFERENCES public.accounts(id),
  CONSTRAINT wire_transfers_rejected_by_fkey FOREIGN KEY (rejected_by) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_reversed_by_fkey FOREIGN KEY (reversed_by) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_held_by_fkey FOREIGN KEY (held_by) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_released_by_fkey FOREIGN KEY (released_by) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_cancelled_by_fkey FOREIGN KEY (cancelled_by) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id),
  CONSTRAINT wire_transfers_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id)
);
CREATE TABLE public.withdrawals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  withdrawal_method text NOT NULL CHECK (withdrawal_method = ANY (ARRAY['bank_transfer'::text, 'wire_transfer'::text, 'check'::text, 'ach'::text, 'crypto'::text])),
  destination_account text,
  destination_bank text,
  routing_number text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'cancelled'::text, 'rejected'::text])),
  rejection_reason text,
  admin_notes text,
  processed_by uuid,
  approved_at timestamp with time zone,
  rejected_at timestamp with time zone,
  completed_at timestamp with time zone,
  reference_number text UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT withdrawals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.zelle_contacts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  name text NOT NULL,
  email text,
  phone text,
  is_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  nickname text,
  CONSTRAINT zelle_contacts_pkey PRIMARY KEY (id),
  CONSTRAINT zelle_contacts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.zelle_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid UNIQUE,
  daily_limit numeric DEFAULT 2500 CHECK (daily_limit >= 0::numeric),
  monthly_limit numeric DEFAULT 20000 CHECK (monthly_limit >= 0::numeric),
  notifications_enabled boolean DEFAULT true,
  sms_notifications boolean DEFAULT true,
  email_notifications boolean DEFAULT true,
  auto_accept_from_contacts boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  notification_enabled boolean DEFAULT true,
  CONSTRAINT zelle_settings_pkey PRIMARY KEY (id),
  CONSTRAINT zelle_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.zelle_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid,
  sender_account_id uuid,
  recipient_contact text,
  recipient_user_id uuid,
  amount numeric CHECK (amount > 0::numeric),
  memo text,
  transaction_type text CHECK (transaction_type = ANY (ARRAY['send'::text, 'request'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text, 'cancelled'::text, 'expired'::text])),
  reference_number text UNIQUE,
  processed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT zelle_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT zelle_transactions_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES auth.users(id),
  CONSTRAINT zelle_transactions_sender_account_id_fkey FOREIGN KEY (sender_account_id) REFERENCES public.accounts(id),
  CONSTRAINT zelle_transactions_recipient_user_id_fkey FOREIGN KEY (recipient_user_id) REFERENCES auth.users(id)
);